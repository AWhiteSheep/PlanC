@using PlanC.Client.Components
@inherits CourseTemplateFormComponent



<!-- Formulaire d'un nouveau plan-cadre -->

@if (!IsReadOnly)
{ 
    <PlanC.Client.Components.DropdownProgramSelection @ref="ProgramSelect"></PlanC.Client.Components.DropdownProgramSelection>
}
    <div class="row">
        <div class="col-12">
            <h3> Formulaire de plan-cadre: </h3>
        </div>
        <div class="col-12">
            <div class="form-group">
                <label class="control-label" for="CrsTitle"> Titre du du programme: </label>
                <input readonly type="text" class="form-control" value="@Program.ToString()" />
            </div>
        </div>
    </div>
 <EditForm EditContext="editContext">
     @*The Data annotations validator uses annotations on the properties of the specified EF model to perform validations*@
    <DataAnnotationsValidator />
        <div class="row">
            <!-- Valeur pour le titre du plan-cadre -->
            <div class="col-lg-6">
                <div class="form-group">
                    <label class="control-label" for="CrsTitle"> Nom du cours associé: </label>
                    <input readonly="@IsReadOnly" type="text" @bind="Template.DenominationCours" class="form-control" />
                </div>
            </div>
            <!-- Valeur pour l'identification du cours -->
            <div class="col-lg-6">
                <div class="form-group">
                    <label class="control-label" for="CrsId"> Identifiant du cours: </label>
                    <InputText readonly="@IsReadOnly" type="text" @bind-Value="Template.CoursId" class="form-control" />
                    <ValidationMessage For="(() => Template.CoursId)"></ValidationMessage>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- Nombre d'unités pour le cours donné -->
            <div class="col-md-6">
                <div class="form-group">
                    <label class="control-label" for="Units"> Nombre d'unités: </label>
                    <ValidationMessage For="() => Template.UnitsAccessor"></ValidationMessage>
                    <InputNumber readonly="@IsReadOnly" TValue="decimal" @bind-Value="Template.UnitsAccessor" class="form-control theme-mask input" id="Units" />
                </div>
            </div>
            <!-- Ajout de la pondération -->
            <div class="col-md-6">
                <div class="form-group text-center">
                    <label class="control-label" for="Ponderation"> Pondération du cours: </label>
                        <div class="row">
                            <label class="col-md-10" for="@(Template.TheoryHoursAccessor)">Nombre d'heures de théorie: </label>
                            <InputNumber readonly="@IsReadOnly" class="col-md-2 theme-mask form-control" TValue="int" Mask="0" @bind-Value="Template.TheoryHoursAccessor" />
                        </div>
                        <div class="row">
                            <label class="col-md-10" for="@(Template.PracticeHoursAccessor)">Nombre d'heures de pratique: </label>
                            <InputNumber readonly="@IsReadOnly" class="col-md-2 theme-mask form-control" TValue="int" Mask="0" @bind-Value="Template.PracticeHoursAccessor" />
                        </div>
                        <div class="row">
                            <label class="col-md-10" for="@(Template.HomeHoursAccessor)">Nombre d'heures à la maison: </label>
                            <InputNumber readonly="@IsReadOnly" class="col-md-2 theme-mask form-control" TValue="int" Mask="0"  @bind-Value="Template.HomeHoursAccessor" />
                        </div>
                </div>
            </div>
            <!-- Séparateur -->
            <hr />
            <div class="col-12">
                <!-- Descriptions du cours -->
                <div class="form-group">
                    <label class="control-label col-12" for="CrsDesc">Description complète du cours: </label>
                    <textarea readonly="@IsReadOnly" @bind="Template.Description" rows="4" class="form-control" id="CrsIntent" name="CrsDesc" />
                </div>
            </div>
            <div class="col-12">
                <!-- les intentions du cours -->
                <div class="form-group">
                    <label class="control-label" for="CrsIntent">Intentions éducatives: </label>
                    <textarea readonly="@IsReadOnly" @bind="Template.IntentionEducative" rows="4" class="form-control" id="CrsIntent" name="CrsIntent" />
                </div>
            </div>
            <div class="col-12">
                <!-- Entrés pour les intentions pédagogiques du cours -->
                <!-- text editor formaté -->
                <div class="form-group">
                    <label class="control-label" for="IntentionPedagogique">Remarque: </label>
                    <textarea readonly="@IsReadOnly" @bind="Template.IntentionPedagogique" rows="4" class="form-control" id="IntentionPedagogique" name="IntentionPedagogique" />
                </div>
            </div>
            <!-- Plus tard dans la section approbation-->
            <div class="row" style="display:contents">
                <div class="col-md-4">
                    <label class="label-info">Date d'approbation en département</label>
                    <input readonly="@IsReadOnly" type="date"  @bind="Template.DateApprobationDepartement" class="form-control input"/>
                </div>
                <div class="col-md-4">
                    <label class="label-info">Date d'approbation en comité</label>
                    <input readonly="@IsReadOnly" type="date" @bind="Template.DateApprobationCommite" class="form-control input"/>
                </div>
                <div class="col-md-4">
                    <label class="label-info">Date d'approbation de la direction de études</label>
                    <input readonly="@IsReadOnly" type="date" @bind="Template.DateApprobationDepartement" class="form-control input"/>
                </div>
            </div>
        </div>
    </EditForm>


@code {
    public Programmes Program { get; set; }

    //Passed by the parent form with two-way binding so that changes made in this component propagate upwards.
    [Parameter]
    public PlansCadres Template { get; set; }

    //Required by blazor to handle two-way binding
    [Parameter]
    public EventCallback<PlansCadres> TemplateChanged { get; set; }

    //Passed down by the parent form
    [CascadingParameter]
    protected PCU001Context context { get; set; }

    //Passed down by the parent form. Determines data access behavior.
    [CascadingParameter]
    public FormPlanCadre.FormMode CurrentMode { get; set; }

    //Dropdown list populated with database program data.
    private DropdownProgramSelection ProgramSelect { get; set; }

    //Blazor component which implements validation using EF model data annotations.
    [Bindable]
    [Parameter]
    public EditContext editContext { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; } = false;

    //Callback given to the program selection dropdown box. Updates program property.
    private void UpdateProgram(object sender, Programmes arg)
    {
        Program = arg;
        StateHasChanged();
    }

    //Initializes the validator with the EF model.
    protected override void OnInitialized()
    {
        editContext = new EditContext(Template);
    }

    
    protected override void OnParametersSet()
    {
        switch (CurrentMode)
        {
            case FormPlanCadre.FormMode.CREATE:
                Program = context.Programmes.FirstOrDefault();
                break;
            case FormPlanCadre.FormMode.EDIT:
                Program = context.Programmes.SingleOrDefault(p => p.Id == Template.ProgrammeId);
                break;
            default:
                throw new Exception($"Error in {this}: CurrentMode is {CurrentMode}");
        }
    }

    /// <summary>
    /// Adds method UpdateProgram to the dropdown program selection component's ValueChanged event.
    /// </summary>
    /// <param name="firstRender">Denotes whether this is the first time the component is rendered.</param>
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && !IsReadOnly)
        {
            ProgramSelect.ValueChanged += UpdateProgram;
        }
    }

    /// <summary>
    /// Attempts to save current data into the database.
    /// </summary>
    /// <returns>True if changes were successfully saved to the database; false otherwise.</returns>
    public override bool SaveProgress()
    {
        if (editContext.Validate())
        {
            switch (CurrentMode)
            {
                case FormPlanCadre.FormMode.CREATE:
                    try
                    {
                        Template.ProgrammeId = Program.Id;
                        Template.VsnCdttm = DateTime.Now;

                        context.PlansCadres.Add(Template);

                        if (context.SaveChanges() > 0)
                        {
                            return true;
                        }
                        else return false;
                    }
                    catch (Exception except)
                    {
                        Console.WriteLine($"Template input error: {except.Message}");
                        return false;
                    }
                case FormPlanCadre.FormMode.EDIT:
                    try
                    {
                        Template.ProgrammeId = Program.Id;

                        context.PlansCadres.Update(Template);

                        if (context.SaveChanges() > 0)
                        {
                            return true;
                        }
                        else return false;
                    }
                    catch (Exception except)
                    {
                        Console.WriteLine($"Template input error: {except.Message}");
                        return false;
                    }
                default:
                    throw new Exception($"Error in {this}: CurrentMode is {CurrentMode}");
            }

        }
        else
        {
            return false;
        }
    }
}
